<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../../bower_components/google-chart/google-chart.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">


<dom-module id="blg-report-viewer">
    <template>
        <style include="shared-styles">
            :host {
                display: block;

                padding: 10px;
            }

            .card {
                padding: 0;
            }

            .card .ivr-title {
                height: 80px;
                display: flex;
                align-items: center;
                padding: 0px 20px;
                background: var(--oredata-color);
                background: #fff;
                border-bottom: 3px solid var(--oredata-color);
                /* @apply --shadow-elevation-2dp; */
            }

            .card .ivr-title h1 {
                margin: 0;
                font-weight: 500;
                color: #222;
            }

            .card .ivr-title vaadin-date-picker {
                color: #fff;
                margin-top: -10px;
            }



            .card .ivr-container {
                margin: 20px;
                @apply --layout-vertical;
                @apply --layout-center-center;
            }

            .flex {
                @apply --layout-flex;
            }

            .not-found-data {
                min-height: 50px;
                font-weight: bold;
                font-size: 20px;
            }

            .image {
                height: 400px;
                width: 600px;
            }

            .image iron-image {
                width: 100%;
                height: 100%;
            }

            google-chart {
                height: 400px;
                width: 50em;
            }
        </style>

        <div id="error" class="horizontal-flex"></div>
        <div hidden$={{!isData}}>
            <google-chart type=[[chartData.type]] options=[[chartData.options]] data=[[chartData.data]]></google-chart>
        </div>

        <div class="loading-panel" hidden$={{!loading}}>
            <paper-spinner active={{loading}}></paper-spinner>
        </div>
    </template>

    <script>
        /**
         * `blg-report-viewer` Description
         *
         * @summary ShortDescription.
         * @customElement
         * @polymer
         * @extends {Polymer.Element}
         */
        class BlgReportViewer extends Polymer.Element {
            /**
             * String providing the tag name to register the element under.
             */
            static get is() {
                return 'blg-report-viewer';
            }

            static get properties() {
                return {
                    tree: {
                        type: Object,
                        observer: '_treeChanged'
                    },
                    selecteddate: {
                        type: String,
                        observer: '_selectedDateChanged'
                    },
                    chartData: {
                        type: Object,
                        notify: true
                    },
                    isData: {
                        type: Boolean,
                        value: false,
                    }
                };
            }

            _treeChanged(tree, oldVal) {
                // console.log('_treeChanged', tree);
                if (tree && oldVal !== undefined) {
                    this._clearTree();
                    let jsonUrl = './src/ivr/raporlar/' + this.hakkeday + '/' + tree.type + '/' + tree.category +
                        '/' + tree.title + '.json';
                    // let jsonUrl = './src/ivr/' + this.hakkeday + '-' + this.ivrtype + '.json';
                    this._init(jsonUrl);
                }
            }

            _selectedDateChanged(newVal, oldVal) {
                // console.log('_selectedDateChanged', newVal);
                if (newVal) {
                    this.set('loading', true);
                    this._clearTree();
                    this.set('hakkeday', newVal);
                    setTimeout(() => {
                        let jsonUrl = './src/ivr/raporlar/' + this.hakkeday + '/' + this.tree.type +
                            '/' + this.tree.category + '/' + this.tree.title + '.json';
                        // let jsonUrl = './src/ivr/' + newVal + '-' + this.ivrtype + '.json';
                        this._init(jsonUrl);
                    }, 1000);

                }
            }
            _clearTree() {
                this.$.error.innerHTML = "";
                // this.set('chartData', {} );
            }

            _init(jsonUrl) {
                const that = this;
                let json = {};

                fetch(jsonUrl)
                    .then(function (response) {
                        return response.json();
                    })
                    .then(myJson => {
                        this.set('isData', true);
                        // console.log(myJson);
                        this.set('chartData', myJson);
                        // var tree = [myJson];
                        // var res = that.recursive_tree(tree, 'div', 'ul', 0);
                        // $app.appendChild(res);
                        this.set('loading', false);
                    })
                    .catch(error => {
                        this.set('isData', false);

                        // console.log(error);
                        let $error = this.$.error;
                        // console.log(error);
                        let divError = document.createElement('h4');
                        divError.classList.add('not-found-data');
                        const textNode = document.createTextNode('Veri BulunamadÄ±!');
                        divError.appendChild(textNode);
                        $error.appendChild(divError);
                        this.set('loading', false);
                    });

            }



            connectedCallback() {
                super.connectedCallback();

            }


        }

        window.customElements.define(BlgReportViewer.is, BlgReportViewer);
    </script>
</dom-module>